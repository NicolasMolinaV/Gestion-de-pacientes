<!DOCTYPE html>
<html lang="es" class="layout-menu-fixed layout-compact" data-assets-path="../assets/"
  data-template="vertical-menu-template-free">

<head>
  <meta charset="utf-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <title>Registrar Paciente</title>
  <link rel="icon" type="image/x-icon" href="../assets/img/favicon/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="../assets/vendor/fonts/iconify-icons.css" />
  <link rel="stylesheet" href="../assets/vendor/css/core.css" />
  <link rel="stylesheet" href="../assets/css/demo.css" />
  <link rel="stylesheet" href="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
  <script src="../assets/vendor/js/helpers.js"></script>
  <script src="../assets/js/config.js"></script>
</head>
<style>
  .mensaje-exito {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.5);
    background-color: #60c976;
    color: white;
    padding: 30px 60px;
    border-radius: 20px;
    font-size: 26px;
    font-weight: bold;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    text-align: center;
    z-index: 9999;
    opacity: 0;
    transition: transform 0.5s ease, opacity 0.5s ease;
    font-family: 'Segoe UI', sans-serif;
  }

  .mensaje-exito.show {
    display: block;
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
</style>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->

      <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
        <div class="app-brand demo">
          <a href="index.html" class="app-brand-link">
            <span class="app-brand-logo demo">
              <span class="text-primary">
                <img src="../assets/img/favicon/Logo.png" width="140" style="position: relative; left: 20px;" />
              </span>
            </span>
            <span class="app-brand-text demo menu-text fw-bold ms-2"></span>
          </a>

          <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
            <i class="bx bx-chevron-left d-block d-xl-none align-middle"></i>
          </a>
        </div>

        <div class="menu-divider mt-0"></div>

        <div class="menu-inner-shadow"></div>

        <ul class="menu-inner py-1">
          <!-- Dashboards -->
          <li class="menu-item">
            <a href="index.html" class="menu-link">
              <i class="menu-icon tf-icons bx bx-home-smile"></i>
              <div class="text-truncate" data-i18n="Dashboards">Inicio</div>
            </a>
          </li>






          <!-- Pages -->
          <li class="menu-item active open">
            <a href="javascript:void(0);" class="menu-link menu-toggle">
              <i class="menu-icon tf-icons bx bx-dock-top"></i>
              <div class="text-truncate" data-i18n="Account Settings">Pacientes</div>
            </a>
            <ul class="menu-sub">
              <li class="menu-item active">
                <a href="registrar.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Account">Registrar Pacientes</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="editarpaciente.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Notifications">Editar Información Paciente</div>
                </a>
              </li>
              <li class="menu-item">
                <a href="infopaciente.html" class="menu-link">
                  <div class="text-truncate" data-i18n="Connections">Información Completa </div>
                </a>
              </li>
            </ul>
          </li>






        </ul>
      </aside>

      <div class="layout-page">
        <nav
          class="layout-navbar container-xxl navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme">
          <div class="layout-menu-toggle navbar-nav align-items-xl-center me-3 me-xl-0 d-xl-none">
            <a class="nav-item nav-link px-0 me-xl-4" href="javascript:void(0)">
              <i class="bx bx-menu bx-sm"></i>
            </a>
          </div>
          <div class="navbar-nav-right d-flex align-items-center" id="navbar-collapse">
            <ul class="navbar-nav flex-row align-items-center ms-auto">
              <li class="nav-item lh-1 me-3">
                <span class="fw-semibold d-block">Sistema Salud Total</span>
              </li>
            </ul>
          </div>
        </nav>

        <div class="content-wrapper">
          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="card mb-4">
              <h5 class="card-header">Registrar Paciente</h5>
              <div class="card-body">
                <form id="form-registro">
                  <div class="row g-4">
                    <div class="col-md-6">
                      <label class="form-label">RUT</label>
                      <input type="text" id="rut" name="rut" class="form-control" required placeholder="12.345.678-K">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Sexo</label>
                      <select name="sexo" class="form-select" required>
                        <option value="" disabled selected>Seleccione Sexo</option>
                        <option value="1">Masculino</option>
                        <option value="2">Femenino</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Nombres</label>
                      <input type="text" name="nombre" maxlength="50" pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ ]+"
                        class="form-control" required placeholder="Ej: Juan Carlos">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Apellidos</label>
                      <input type="text" name="apellidos" maxlength="50" pattern="[A-Za-zÁÉÍÓÚÑáéíóúñ ]+"
                        class="form-control" required placeholder="Ej: Pérez Lopez">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Fecha de Nacimiento</label>
                      <input type="date" name="fechaNacimiento" id="fechaNacimiento" class="form-control" required>
                      <span id="edadVisual" class="text-muted small mt-1 d-block"></span>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Teléfono</label>
                      <div class="input-group">
                        <span class="input-group-text">+56</span>
                        <input type="tel" name="telefono" maxlength="9" class="form-control" required
                          placeholder="912345678">
                      </div>
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Teléfonos de Emergencia</label>
                      <div id="telefonosEmergenciaContainer">
                        <div class="row mb-3 emergencia-group">
                          <div class="col-md-5">
                            <div class="input-group">
                              <span class="input-group-text">+56</span>
                              <input type="tel" class="form-control telefono-emergencia" maxlength="9"
                                placeholder="912345678" required />
                            </div>
                          </div>
                          <div class="col-md-5">
                            <select class="form-select parentesco" required>
                              <option value="">Seleccione Parentesco</option>
                              <option>Madre</option>
                              <option>Padre</option>
                              <option>Hermano/a</option>
                              <option>Tío/a</option>
                              <option>Sobrino/a</option>
                              <option>Abuelo/a</option>
                              <option>Nieto/a</option>
                              <option>Hijo/a</option>
                            </select>
                          </div>
                          <div class="col-md-2 d-flex align-items-center">
                            <button type="button" class="btn btn-sm btn-outline-primary"
                              onclick="agregarTelefonoEmergencia()">+</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Dirección</label>
                      <input type="text" name="direccion" maxlength="100" class="form-control"
                        placeholder="Ej: Los Leones #1234" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Alergias (si tiene)</label>
                      <input type="text" name="alergias" maxlength="100" class="form-control"
                        placeholder="Ej: Penicilina">
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Seguro Médico</label>
                      <select id="seguro" class="form-select" required>
                        <option value="" disabled selected>Seleccione un tipo de seguro</option>
                        <option value="Fonasa">Fonasa</option>
                        <option value="Isapre">Isapre</option>
                        <option value="Particular">Particular</option>
                        <option value="Otro">Otro</option>
                      </select>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Descripción del Seguro</label>
                      <select id="descripcionSeguro" class="form-select" disabled required>
                        <option value="" disabled selected>Seleccione primero un seguro</option>
                      </select>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Médico Asignado</label>
                      <select name="id_medico" class="form-select" required>
                        <option value="" disabled selected>Seleccione médico</option>
                      </select>
                    </div>

                    <div class="col-md-6">
                      <label class="form-label">Grupo Sanguíneo</label>
                      <select name="grupo_sangre_id" class="form-select" required>
                        <option value="" disabled selected>Seleccione grupo</option>
                      </select>
                    </div>

                    <div class="col-md-12">
                      <label class="form-label">Observación</label>
                      <textarea name="observacion" rows="3" class="form-control"
                        placeholder="Observaciones adicionales..."></textarea>
                    </div>

                    <div class="mt-4">
                      <button type="submit" class="btn btn-primary">Guardar</button>
                      <span id="mensaje-error" class="text-danger ms-3"></span>
                    </div>
                </form>
              </div>
            </div>
          </div>
          <footer class="content-footer footer bg-footer-theme">
            <div class="container-xxl d-flex justify-content-between py-2">
              <span>© 2025 - Clínica Salud Total</span>
            </div>
          </footer>
        </div>
        <!-- Mensaje flotante animado de éxito -->
        <div id="registroExitosoMsg" class="mensaje-exito">¡Registro exitoso!</div>

      </div>
    </div>
  </div>
  <script>



  </script>


  <script src="../assets/vendor/libs/jquery/jquery.js"></script>
  <script src="../assets/vendor/libs/popper/popper.js"></script>
  <script src="../assets/vendor/js/bootstrap.js"></script>
  <script src="../assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js"></script>
  <script src="../assets/vendor/js/menu.js"></script>
  <script src="../assets/js/main.js"></script>
  <script src="../assets/js/validar-rut.js"></script>

  <script>
    const apiUrl = "https://crud-gestion-pacientes.onrender.com/api/gestion_pacientes_app/";
    let maxTelefonos = 3;

    function agregarTelefonoEmergencia() {
      const container = document.getElementById("telefonosEmergenciaContainer");
      const existentes = container.querySelectorAll(".emergencia-group").length;
      if (existentes >= maxTelefonos) return;

      const nuevo = document.createElement("div");
      nuevo.className = "row mb-3 emergencia-group";
      nuevo.innerHTML = `
      <div class="col-md-5">
        <div class="input-group">
          <span class="input-group-text">+56</span>
          <input type="tel" class="form-control telefono-emergencia" maxlength="9" placeholder="912345678" required />
        </div>
      </div>
      <div class="col-md-5">
        <select class="form-select parentesco" required>
          <option value="">Seleccione Parentesco</option>
          <option>Madre</option>
          <option>Padre</option>
          <option>Hermano/a</option>
          <option>Tío/a</option>
          <option>Sobrino/a</option>
          <option>Abuelo/a</option>
          <option>Nieto/a</option>
          <option>Hijo/a</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-center">
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarTelefonoEmergencia(this)">−</button>
      </div>
    `;
      container.appendChild(nuevo);
      validarNumeros();
    }

    function eliminarTelefonoEmergencia(btn) {
      const grupo = btn.closest(".emergencia-group");
      grupo.remove();
    }

    function validarNumeros() {
      document.querySelectorAll(".telefono-emergencia").forEach(input => {
        input.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/[^0-9]/g, "");
          if (!e.target.value.startsWith("9")) {
            e.target.setCustomValidity("Debe comenzar con 9");
          } else if (e.target.value.length !== 9) {
            e.target.setCustomValidity("Debe tener 9 dígitos");
          } else {
            e.target.setCustomValidity("");
          }
        });
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const seguroSelect = document.getElementById("seguro");
      const descripcionSelect = document.getElementById("descripcionSeguro");

      const opcionesDescripcion = {
        Fonasa: ["A", "B", "C", "D"],
        Isapre: ["Plan Básico", "Plan Complementario", "Plan Premium"],
        Particular: ["Consulta libre", "Atención particular"],
        Otro: ["Convenio empresa", "Otro"]
      };

      seguroSelect.addEventListener("change", () => {
        const seguro = seguroSelect.value;
        descripcionSelect.innerHTML = `<option value="" disabled selected>Seleccione una opción</option>`;

        if (opcionesDescripcion[seguro]) {
          opcionesDescripcion[seguro].forEach(op => {
            const opt = document.createElement("option");
            opt.value = op;
            opt.textContent = op;
            descripcionSelect.appendChild(opt);
          });
          descripcionSelect.disabled = false;
        } else {
          descripcionSelect.disabled = true;
        }
      });
    });


    function calcularEdad(fecha) {
      const hoy = new Date();
      const nacimiento = new Date(fecha);
      let edad = hoy.getFullYear() - nacimiento.getFullYear();
      const m = hoy.getMonth() - nacimiento.getMonth();
      if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
        edad--;
      }
      return edad;
    }

    document.addEventListener("DOMContentLoaded", () => {
      validarNumeros();

      const fechaInput = document.getElementById("fechaNacimiento");
      const edadVisual = document.getElementById("edadVisual");
      const form = document.getElementById("form-registro");

      const hoy = new Date();
      const yyyy = hoy.getFullYear();
      const mm = String(hoy.getMonth() + 1).padStart(2, '0');
      const dd = String(hoy.getDate()).padStart(2, '0');
      fechaInput.max = `${yyyy}-${mm}-${dd}`;

      fechaInput.addEventListener("change", () => {
        const fecha = fechaInput.value;
        if (fecha) {
          const edad = calcularEdad(fecha);
          edadVisual.textContent = `Edad: ${edad} años`;
        } else {
          edadVisual.textContent = "";
        }
      });

      document.getElementById('rut').addEventListener('input', function (e) {
        let valor = e.target.value.replace(/[^\dkK]/g, '').toUpperCase();

        if (valor.length > 1) {
          let cuerpo = valor.slice(0, -1);
          let dv = valor.slice(-1);

          cuerpo = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

          e.target.value = `${cuerpo}-${dv}`;
        } else {
          e.target.value = valor;
        }
      });
      function rutANumero(rut) {
        return parseInt(rut.replace(/\D/g, '').slice(0, -1));
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const nacimiento = new Date(form.fechaNacimiento.value);
        const hoySinHora = new Date();
        hoySinHora.setHours(0, 0, 0, 0);

        if (nacimiento > hoySinHora) {
          alert("La fecha de nacimiento no puede ser futura.");
          return;
        }

        const telefonoEmergencia = document.querySelector('.telefono-emergencia')?.value || '';
        const parentesco = document.querySelector('.parentesco')?.value || '';

        // Validación: verificar que el ID del médico sea válido
        const medicoSeleccionado = parseInt(form.id_medico.value);
        if (isNaN(medicoSeleccionado) || medicoSeleccionado === 0) {
          console.error("Debe seleccionar un médico válido.");
          alert("Seleccione un médico válido antes de continuar.");
          return;
        }

        console.log("ID del médico seleccionado:", medicoSeleccionado);


        const nuevoPaciente = {
          rut: form.rut.value.trim(),
          id_pac: rutANumero(form.rut.value),
          sexo: parseInt(form.sexo.value),
          nombre: form.nombre.value.trim(),
          apellido: form.apellidos.value.trim(),
          fecha_nac: form.fechaNacimiento.value,
          direccion: form.direccion.value.trim(),
          telefono: form.telefono.value.trim(),
          alergias: form.alergias.value.trim(),
          seguro_medico: `${document.getElementById("seguro").value} ${document.getElementById("descripcionSeguro").value}`,
          obser_clinica: form.observacion.value.trim(),
          grupo_sanguineo: parseInt(form.grupo_sangre_id.value),
          medico: parseInt(form.id_medico.value),
          contacto_emergencia: {
            id_doc: parseInt(form.rut.value.trim()), // si esta es la FK al paciente, debe ser int
            contacto: parseInt(document.querySelector('.telefono-emergencia')?.value || '0'),
            parentesco: document.querySelector('.parentesco')?.value || '',
            paciente: 1, // si esta es la FK al paciente, debe ser int
            medico: parseInt(form.id_medico.value)
          }
        };
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(nuevoPaciente)
          });

          if (!response.ok) {
            const errorData = await response.json();
            console.error('Error en la respuesta:', errorData);
            document.getElementById('mensaje-error').textContent = 'Error al guardar en la API: ' + JSON.stringify(errorData);
            return;
          }


          const pacientes = JSON.parse(localStorage.getItem("pacientesData")) || [];
          const existe = pacientes.some(p => p.rut === nuevoPaciente.rut);
          if (existe) {
            alert("Este paciente ya está registrado localmente.");
            return;
          }

          pacientes.push(nuevoPaciente);
          localStorage.setItem("pacientesData", JSON.stringify(pacientes));

          const msg = document.getElementById("registroExitosoMsg");
          msg.classList.add("show");
          form.reset();
          edadVisual.textContent = "";

          setTimeout(() => {
            msg.style.display = "none";
            window.location.href = "index.html";
          }, 2000);

        } catch (error) {
          console.error('Error al enviar los datos:', error);
          document.getElementById('mensaje-error').textContent = 'Error de conexión.';
        }
      });

    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      fetch('https://crud-gestion-pacientes.onrender.com/api/medicos/')
        .then(res => res.json())
        .then(data => {
          const selectMed = document.querySelector('select[name="id_medico"]');
          data.forEach(med => {
            const opt = document.createElement('option');
            opt.value = med.id;
            opt.textContent = med.nombre_completo;
            selectMed.appendChild(opt);
          });
        })
        .catch(err => console.error('Error al cargar médicos:', err));

      fetch('https://crud-gestion-pacientes.onrender.com/api/grupos_sanguineos/')
        .then(res => res.json())
        .then(data => {
          const selectGrupo = document.querySelector('select[name="grupo_sangre_id"]');
          data.forEach(gr => {
            const opt = document.createElement('option');
            opt.value = gr.id;
            opt.textContent = gr.nombre;
            selectGrupo.appendChild(opt);
          });
        })
        .catch(err => console.error('Error al cargar grupos sanguíneos:', err));
    });
  </script>
</body>

</html>